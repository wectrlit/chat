<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SecretLink</title>

  <!--
    SecretLink â€” P2P Secret Chat (PeerJS edition)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Deploy: chá»‰ cáº§n 1 repo GitHub + GitHub Pages.
    KhÃ´ng cáº§n server riÃªng.

    Cáº¥u trÃºc thÆ° má»¥c:
      index.html          â† file nÃ y
      lang/
        manifest.json     â† danh sÃ¡ch mÃ£ ngÃ´n ngá»¯, VD: ["vi","en","fr"]
        vi.json           â† Tiáº¿ng Viá»‡t
        en.json           â† English
        fr.json           â† ThÃªm ngÃ´n ngá»¯ má»›i: chá»‰ cáº§n thÃªm file + khai bÃ¡o trong manifest
  -->

  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Sora:wght@300;400;600&display=swap');

    :root {
      --bg:          #080c10;
      --surface:     #0d1117;
      --surface2:    #161b22;
      --surface3:    #1c2333;
      --border:      #21262d;
      --accent:      #00e5a0;
      --accent-dim:  #00b47c;
      --accent-glow: rgba(0,229,160,0.13);
      --danger:      #ff4757;
      --warn:        #ffa502;
      --text:        #e6edf3;
      --text-muted:  #7d8590;
      --bubble-me:   #003d28;
      --bubble-them: #141e2e;
      --mono:        'JetBrains Mono', monospace;
      --sans:        'Sora', sans-serif;
      --tr:          0.18s ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
    }

    #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOPBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 18px; height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0; z-index: 100; gap: 10px;
    }

    .logo {
      font-family: var(--mono); font-weight: 700; font-size: 15px;
      color: var(--accent); letter-spacing: .04em; flex-shrink: 0;
      user-select: none;
    }
    .logo span { color: var(--text-muted); font-weight: 300; }

    #topbar-right { display: flex; align-items: center; gap: 8px; }

    /* Status pill */
    #status-pill {
      display: flex; align-items: center; gap: 6px;
      font-family: var(--mono); font-size: 11px;
      padding: 4px 10px; border-radius: 20px;
      border: 1px solid var(--border);
      color: var(--text-muted); background: var(--surface2);
      white-space: nowrap; transition: var(--tr);
    }
    #status-pill .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--text-muted); flex-shrink: 0; transition: var(--tr);
    }
    #status-pill.connecting  { border-color: var(--warn);   color: var(--warn);   }
    #status-pill.connecting  .dot { background: var(--warn);   animation: blink 1s infinite; }
    #status-pill.connected   { border-color: var(--accent); color: var(--accent); }
    #status-pill.connected   .dot { background: var(--accent); box-shadow: 0 0 7px var(--accent); animation: pulse 2s infinite; }
    #status-pill.error       { border-color: var(--danger); color: var(--danger); }
    #status-pill.error       .dot { background: var(--danger); }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }

    /* Language select â€” tá»± má»Ÿ rá»™ng theo sá»‘ ngÃ´n ngá»¯ */
    #lang-select {
      font-family: var(--mono); font-size: 12px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); border-radius: 6px;
      padding: 4px 8px; cursor: pointer; outline: none; transition: var(--tr);
      max-width: 160px;
    }
    #lang-select:hover { border-color: var(--accent); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ALERTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #alerts { flex-shrink: 0; }
    .alert-banner {
      padding: 8px 18px; font-size: 12px; font-family: var(--mono);
      display: flex; align-items: center; gap: 8px;
      animation: slideDown .2s ease;
    }
    .alert-banner.warn   { background: rgba(255,165,2,.10); color: var(--warn);   border-bottom: 1px solid rgba(255,165,2,.2); }
    .alert-banner.danger { background: rgba(255,71,87,.10); color: var(--danger); border-bottom: 1px solid rgba(255,71,87,.2); }
    .alert-banner.info   { background: rgba(0,229,160,.08); color: var(--accent); border-bottom: 1px solid rgba(0,229,160,.15); }
    @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:none} }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCREENS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #main { flex: 1; display: flex; overflow: hidden; position: relative; }

    .screen {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      transition: opacity .3s ease, transform .3s ease;
      overflow-y: auto;
    }
    .screen.hidden { opacity: 0; pointer-events: none; transform: scale(.97); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETUP SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #setup-screen { background: var(--bg); padding: 40px 20px; }

    .setup-card {
      width: 100%; max-width: 440px;
      display: flex; flex-direction: column; gap: 20px;
    }

    .setup-hero { text-align: center; }
    .setup-hero h1 {
      font-family: var(--mono); font-size: clamp(22px,4vw,30px);
      font-weight: 700; color: var(--accent);
      letter-spacing: -.01em; margin-bottom: 8px;
    }
    .setup-hero p { font-size: 13px; color: var(--text-muted); line-height: 1.65; }

    /* Card */
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 24px;
      display: flex; flex-direction: column; gap: 14px;
    }
    .card-label {
      font-family: var(--mono); font-size: 10px;
      text-transform: uppercase; letter-spacing: .12em; color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 7px; padding: 10px 16px; border-radius: 8px; border: none;
      cursor: pointer; font-family: var(--mono); font-size: 13px; font-weight: 500;
      transition: var(--tr); white-space: nowrap; flex-shrink: 0;
    }
    .btn-primary   { background: var(--accent); color: #000; }
    .btn-primary:hover   { background: var(--accent-dim); }
    .btn-secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    .btn-ghost     { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-ghost:hover { border-color: var(--danger); color: var(--danger); }
    .btn-danger    { background: rgba(255,71,87,.12); border: 1px solid rgba(255,71,87,.3); color: var(--danger); }
    .btn-danger:hover    { background: rgba(255,71,87,.22); }
    .btn:disabled  { opacity: .38; cursor: not-allowed; pointer-events: none; }
    .btn-sm   { padding: 6px 11px; font-size: 11px; }
    .btn-full { width: 100%; }
    .btn-icon { padding: 8px; border-radius: 7px; font-size: 15px; line-height: 1; }

    /* Input */
    .input {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px; padding: 10px 14px;
      font-family: var(--mono); font-size: 13px; outline: none; transition: var(--tr);
    }
    .input:focus { border-color: var(--accent); }
    .input::placeholder { color: var(--text-muted); }

    /* Room ID big display */
    .room-id-box {
      background: var(--surface2); border: 2px solid var(--accent);
      border-radius: 10px; padding: 16px 18px;
      font-family: var(--mono); font-size: 28px; font-weight: 700;
      color: var(--accent); text-align: center;
      letter-spacing: .22em; user-select: all; cursor: text;
    }

    .row      { display: flex; gap: 10px; align-items: center; }
    .row-end  { justify-content: flex-end; }
    .flex-1   { flex: 1; min-width: 0; }

    /* Spinner */
    .waiting { display: flex; align-items: center; gap: 10px; font-family: var(--mono); font-size: 12px; color: var(--text-muted); }
    .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border); border-top-color: var(--accent); animation: spin .8s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .divider { display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 11px; font-family: var(--mono); }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHAT SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #chat-screen {
      flex-direction: column; background: var(--bg);
      align-items: stretch; justify-content: flex-start;
    }

    /* Chat header */
    #chat-header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 14px; border-bottom: 1px solid var(--border);
      background: var(--surface); flex-shrink: 0;
    }
    #chat-room-label {
      font-family: var(--mono); font-size: 11px; color: var(--text-muted);
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    #chat-room-label span {
      color: var(--accent); font-weight: 700; letter-spacing: .1em;
    }

    /* Inactivity countdown bar */
    #timeout-bar {
      padding: 5px 18px; background: rgba(255,165,2,.08);
      border-bottom: 1px solid rgba(255,165,2,.2);
      font-family: var(--mono); font-size: 11px; color: var(--warn);
      text-align: center; display: none; flex-shrink: 0;
    }
    #timeout-bar.visible { display: block; }

    /* Messages area */
    #messages {
      flex: 1; overflow-y: auto; padding: 18px 18px 10px;
      display: flex; flex-direction: column; gap: 10px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Chat bubbles */
    .bw { display: flex; flex-direction: column; max-width: 72%; animation: fadeUp .18s ease; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(7px)} to{opacity:1;transform:none} }
    .bw.me   { align-self: flex-end;   align-items: flex-end;   }
    .bw.them { align-self: flex-start; align-items: flex-start; }

    .bubble {
      padding: 10px 14px; border-radius: 12px;
      font-size: 14px; line-height: 1.55;
      word-break: break-word; white-space: pre-wrap;
    }
    .bw.me   .bubble { background: var(--bubble-me);   border: 1px solid rgba(0,229,160,.16); border-bottom-right-radius: 4px; }
    .bw.them .bubble { background: var(--bubble-them); border: 1px solid var(--border);        border-bottom-left-radius: 4px;  }
    .bmeta { font-family: var(--mono); font-size: 9px; color: var(--text-muted); margin-top: 3px; padding: 0 4px; }

    /* System messages */
    .sys {
      align-self: center; font-family: var(--mono); font-size: 10px;
      color: var(--text-muted); padding: 3px 12px;
      border: 1px solid var(--border); border-radius: 20px;
      background: var(--surface); max-width: 90%; text-align: center;
    }
    .sys.ok     { color: var(--accent); border-color: rgba(0,229,160,.22); background: rgba(0,229,160,.07); }
    .sys.warn   { color: var(--warn);   border-color: rgba(255,165,2,.22); }
    .sys.danger { color: var(--danger); border-color: rgba(255,71,87,.22); }

    /* File bubble */
    .file-bw {
      display: flex; align-items: center; gap: 11px;
      padding: 10px 13px; border-radius: 12px;
      border: 1px solid var(--border); background: var(--surface2);
      min-width: 200px; max-width: 100%;
    }
    .file-ico {
      width: 36px; height: 36px; border-radius: 8px;
      background: var(--accent-glow); border: 1px solid rgba(0,229,160,.2);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
    }
    .file-info { flex: 1; overflow: hidden; min-width: 0; }
    .file-name { font-family: var(--mono); font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-size { font-family: var(--mono); font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .file-prog { width: 100%; height: 3px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
    .file-prog-bar { height: 100%; background: var(--accent); border-radius: 2px; transition: width .1s linear; width: 0%; }

    /* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-input-area {
      border-top: 1px solid var(--border); background: var(--surface);
      padding: 10px 14px; flex-shrink: 0;
    }
    #chat-input-row { display: flex; gap: 8px; align-items: flex-end; }

    /* File attach button â€” ngang hÃ ng vá»›i textarea */
    #btn-attach {
      flex-shrink: 0;
      height: 40px; width: 40px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 9px; color: var(--text-muted);
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; cursor: pointer; transition: var(--tr);
      align-self: flex-end;
    }
    #btn-attach:hover { border-color: var(--accent); color: var(--accent); }

    #msg-input {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); border-radius: 10px; padding: 10px 13px;
      font-family: var(--sans); font-size: 14px; outline: none;
      resize: none; line-height: 1.5; max-height: 120px;
      overflow-y: auto; transition: var(--tr);
    }
    #msg-input:focus { border-color: var(--accent); }
    #msg-input::placeholder { color: var(--text-muted); }
    #msg-input::-webkit-scrollbar { width: 3px; }
    #msg-input::-webkit-scrollbar-thumb { background: var(--border); }

    #btn-send {
      flex-shrink: 0; align-self: flex-end;
      height: 40px; padding: 0 16px;
      border-radius: 9px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DISCONNECTED OVERLAY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #dc-overlay {
      position: fixed; inset: 0; background: rgba(8,12,16,.94);
      display: none; align-items: center; justify-content: center;
      z-index: 999; backdrop-filter: blur(6px);
    }
    #dc-overlay.visible { display: flex; }
    .dc-card {
      background: var(--surface); border: 1px solid var(--danger);
      border-radius: 16px; padding: 36px; text-align: center;
      max-width: 360px; width: 90%;
      display: flex; flex-direction: column; gap: 14px;
      animation: fadeUp .3s ease;
    }
    .dc-card h2 { font-size: 18px; color: var(--danger); }
    .dc-card p  { font-size: 13px; color: var(--text-muted); line-height: 1.6; }

    /* Loading overlay (khá»Ÿi táº£i ngÃ´n ngá»¯) */
    #loading-overlay {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; flex-direction: column; gap: 16px;
      font-family: var(--mono); font-size: 13px; color: var(--text-muted);
    }
    #loading-overlay .spinner { width: 24px; height: 24px; }
    #loading-overlay.done { display: none; }

    /* Tooltip */
    [data-tip] { position: relative; }
    [data-tip]::after {
      content: attr(data-tip); position: absolute; bottom: calc(100% + 6px); left: 50%;
      transform: translateX(-50%); background: var(--surface3); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: 10px;
      padding: 4px 8px; border-radius: 6px; white-space: nowrap;
      pointer-events: none; opacity: 0; transition: opacity .15s; z-index: 10;
    }
    [data-tip]:hover::after { opacity: 1; }

    /* Utils */
    .hidden { display: none !important; }
    .mt-2 { margin-top: 6px; }
    .text-muted { color: var(--text-muted); }
    .text-sm    { font-size: 12px; }

    @keyframes copyFlash {
      0%,100%{background:var(--surface2);color:var(--text)}
      50%{background:var(--accent-glow);color:var(--accent)}
    }
    .flash { animation: copyFlash .4s ease; }
    * { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner" style="width:24px;height:24px;border-radius:50%;border:2px solid #21262d;border-top-color:#00e5a0;animation:spin .8s linear infinite;"></div>
  <span>Äang táº£i ngÃ´n ngá»¯...</span>
</div>

<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="topbar">
    <div class="logo">SecretLink <span>Î²</span></div>
    <div id="topbar-right">
      <div id="status-pill">
        <span class="dot"></span>
        <span id="status-text" data-i18n="status_idle"></span>
      </div>
      <!-- Dropdown ngÃ´n ngá»¯ â€” tá»± Ä‘iá»n bá»Ÿi JS sau khi load manifest -->
      <select id="lang-select" aria-label="Language"></select>
    </div>
  </div>

  <div id="alerts"></div>

  <div id="main">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="setup-screen" class="screen">
      <div class="setup-card">

        <div class="setup-hero">
          <h1>ğŸ”’ SecretLink</h1>
          <p data-i18n="hero_desc"></p>
        </div>

        <!-- Táº¡o phÃ²ng / vÃ o phÃ²ng -->
        <div class="card" id="action-card">
          <div class="card-label" data-i18n="choose_action"></div>
          <button class="btn btn-primary btn-full" id="btn-create" data-i18n="create_room"></button>
          <div class="divider" data-i18n="or"></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <input
              type="text" class="input" id="join-input"
              data-i18n-placeholder="room_id_placeholder"
              autocomplete="off" spellcheck="false"
              maxlength="6"
              style="text-transform:uppercase;letter-spacing:.18em;text-align:center;font-size:20px;font-family:var(--mono);font-weight:700;"
            />
            <button class="btn btn-secondary btn-full" id="btn-join" data-i18n="join_room"></button>
          </div>
        </div>

        <!-- Chá» peer vÃ o -->
        <div class="card hidden" id="waiting-card">
          <div class="card-label" data-i18n="room_created"></div>
          <p class="text-sm text-muted" data-i18n="share_hint"></p>
          <div class="room-id-box" id="room-id-display">â€”â€”</div>
          <div class="row">
            <button class="btn btn-secondary btn-sm flex-1" id="btn-copy-id"   data-i18n="copy_id"></button>
            <button class="btn btn-secondary btn-sm flex-1" id="btn-copy-link" data-i18n="copy_link"></button>
          </div>
          <div class="waiting">
            <div class="spinner"></div>
            <span data-i18n="waiting_peer"></span>
          </div>
          <button class="btn btn-ghost btn-sm" id="btn-cancel" data-i18n="cancel"></button>
        </div>

        <p class="text-sm text-muted" style="text-align:center;line-height:1.7;" data-i18n="p2p_note"></p>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="chat-screen" class="screen hidden">

      <!-- Header -->
      <div id="chat-header">
        <div id="chat-room-label">
          Room:&nbsp;<span id="chat-room-val">â€”</span>
        </div>
        <!-- XoÃ¡ há»™i thoáº¡i -->
        <button class="btn btn-ghost btn-sm btn-icon" id="btn-clear"
          data-i18n-tip="clear_chat" data-tip="">ğŸ—‘</button>
        <!-- ThoÃ¡t -->
        <button class="btn btn-danger btn-sm" id="btn-disconnect" data-i18n="leave_room"></button>
      </div>

      <!-- Äáº¿m ngÆ°á»£c khi khÃ´ng hoáº¡t Ä‘á»™ng -->
      <div id="timeout-bar">
        <span data-i18n="timeout_warning"></span>&nbsp;<strong id="countdown">300</strong>s
      </div>

      <!-- Tin nháº¯n -->
      <div id="messages"></div>

      <!-- Input area -->
      <div id="chat-input-area">
        <div id="chat-input-row">

          <!-- File attach â€” ngang hÃ ng vá»›i Ã´ soáº¡n tin -->
          <button id="btn-attach" data-i18n-tip="attach_file" data-tip="">ğŸ“</button>
          <input type="file" id="file-input" class="hidden" />

          <textarea
            id="msg-input" rows="1"
            data-i18n-placeholder="msg_placeholder"
          ></textarea>

          <button class="btn btn-primary" id="btn-send" data-i18n="send"></button>
        </div>
      </div>

    </div><!-- /#chat-screen -->

  </div><!-- /#main -->
</div><!-- /#app -->

<!-- Overlay ngáº¯t káº¿t ná»‘i -->
<div id="dc-overlay">
  <div class="dc-card">
    <div style="font-size:40px">ğŸ’”</div>
    <h2 data-i18n="dc_title"></h2>
    <p  data-i18n="dc_desc"></p>
    <button class="btn btn-primary" style="width:100%" id="btn-restart" data-i18n="new_room"></button>
  </div>
</div>

<script>
/* ================================================================
   SecretLink â€” Client
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§1   CONFIG
   Â§2   i18n runtime  (táº£i tá»« lang/*.json)
   Â§3   UI helpers
   Â§4   PeerJS / WebRTC
   Â§5   File transfer
   Â§6   Heartbeat
   Â§7   Inactivity timeout  (5 phÃºt khÃ´ng chat â†’ ngáº¯t)
   Â§8   Tab-focus notification  (cáº£nh bÃ¡o peer, KHÃ”NG tá»± ngáº¯t)
   Â§9   Event listeners
   Â§10  Boot
   ================================================================ */

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§1  CONFIG
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CONFIG = {
  LANG_MANIFEST    : 'lang/manifest.json',
  LANG_DIR         : 'lang/',
  DEFAULT_LANG     : 'vi',

  MAX_FILE_SIZE    : 20 * 1024 * 1024,  // 20 MB
  CHUNK_SIZE       : 16 * 1024,         // 16 KB

  HEARTBEAT_MS     : 10_000,   // gá»­i ping má»—i 10 giÃ¢y
  PONG_TIMEOUT_MS  : 15_000,   // náº¿u khÃ´ng pong sau 15 giÃ¢y â†’ ngáº¯t

  // KhÃ´ng hoáº¡t Ä‘á»™ng (khÃ´ng gá»­i/nháº­n chat) 5 phÃºt â†’ Ä‘áº¿m ngÆ°á»£c 30 giÃ¢y
  INACTIVITY_MS    : 5 * 60 * 1000,
  INACTIVITY_CD_S  : 30,

  ROOM_CHARS       : 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', // bá» I O 0 1
  ROOM_LEN         : 6,
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§2  i18n runtime
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   - Táº£i manifest.json â†’ danh sÃ¡ch mÃ£ ngÃ´n ngá»¯
   - Táº£i tá»«ng file lang/{code}.json song song
   - Äiá»n dropdown, Ã¡p dá»¥ng ngÃ´n ngá»¯
   - ThÃªm ngÃ´n ngá»¯ má»›i: chá»‰ cáº§n thÃªm file + khai bÃ¡o trong manifest
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let i18nData = {};   // { vi: {...}, en: {...}, fr: {...} }
let lang     = CONFIG.DEFAULT_LANG;

/** Láº¥y chuá»—i dá»‹ch theo key ngáº¯n (khÃ´ng cáº§n prefix "ui.") */
function t(key, fallback = key) {
  return i18nData[lang]?.ui?.[key] ?? fallback;
}

/**
 * Táº£i manifest + táº¥t cáº£ file ngÃ´n ngá»¯.
 * Tráº£ vá» Promise â€” resolve khi xong, reject náº¿u manifest khÃ´ng tá»“n táº¡i.
 */
async function loadI18n() {
  // 1. Táº£i manifest
  let codes;
  try {
    const res = await fetch(CONFIG.LANG_MANIFEST);
    if (!res.ok) throw new Error('manifest_not_found');
    codes = await res.json();
  } catch {
    // Fallback khi má»Ÿ file:// local (khÃ´ng cÃ³ server)
    // DÃ¹ng dá»¯ liá»‡u inline tá»‘i thiá»ƒu Ä‘á»ƒ app váº«n cháº¡y
    console.warn('[i18n] KhÃ´ng táº£i Ä‘Æ°á»£c manifest, dÃ¹ng fallback ná»™i tuyáº¿n');
    i18nData = getInlineFallback();
    return;
  }

  // 2. Táº£i song song táº¥t cáº£ ngÃ´n ngá»¯ trong manifest
  const results = await Promise.allSettled(
    codes.map(code =>
      fetch(`${CONFIG.LANG_DIR}${code}.json`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => ({ code, data }))
    )
  );

  results.forEach(r => {
    if (r.status === 'fulfilled') {
      i18nData[r.value.code] = r.value.data;
    }
  });

  // Náº¿u khÃ´ng táº£i Ä‘Æ°á»£c ngÃ´n ngá»¯ nÃ o â†’ dÃ¹ng fallback
  if (Object.keys(i18nData).length === 0) {
    i18nData = getInlineFallback();
  }
}

/**
 * Äiá»n dropdown ngÃ´n ngá»¯ tá»« dá»¯ liá»‡u Ä‘Ã£ táº£i.
 * Má»—i ngÃ´n ngá»¯ má»›i trong manifest tá»± Ä‘á»™ng xuáº¥t hiá»‡n á»Ÿ Ä‘Ã¢y.
 */
function buildLangDropdown() {
  const sel = $('lang-select');
  sel.innerHTML = '';
  Object.entries(i18nData).forEach(([code, data]) => {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = data.meta?.name ?? code;
    sel.appendChild(opt);
  });
  // Chá»n ngÃ´n ngá»¯ phÃ¹ há»£p browser
  const browserLang = navigator.language?.slice(0, 2);
  if (i18nData[browserLang]) lang = browserLang;
  else if (i18nData[CONFIG.DEFAULT_LANG]) lang = CONFIG.DEFAULT_LANG;
  else lang = Object.keys(i18nData)[0];
  sel.value = lang;
}

/** Ãp dá»¥ng ngÃ´n ngá»¯ lÃªn toÃ n bá»™ DOM */
function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPlaceholder);
  });
  document.querySelectorAll('[data-i18n-tip]').forEach(el => {
    el.setAttribute('data-tip', t(el.dataset.i18nTip));
  });
  document.documentElement.lang = lang;
}

/**
 * Dá»¯ liá»‡u ngÃ´n ngá»¯ tá»‘i thiá»ƒu (khi má»Ÿ file:// khÃ´ng cÃ³ server Ä‘á»ƒ fetch).
 * Chá»‰ tiáº¿ng Viá»‡t â€” Ä‘á»§ Ä‘á»ƒ app cháº¡y Ä‘Æ°á»£c.
 */
function getInlineFallback() {
  return {
    vi: {
      meta: { code: 'vi', name: 'Tiáº¿ng Viá»‡t' },
      ui: {
        status_idle: 'ChÆ°a káº¿t ná»‘i', status_connecting: 'Äang káº¿t ná»‘i...', status_waiting: 'Äang chá»...', status_connected: 'ÄÃ£ káº¿t ná»‘i P2P', status_error: 'Lá»—i káº¿t ná»‘i',
        hero_desc: 'Chat P2P bÃ­ máº­t. Chia sáº» mÃ£ phÃ²ng 6 kÃ½ tá»±.', choose_action: 'Báº¯t Ä‘áº§u', create_room: '+ Táº¡o phÃ²ng má»›i', join_room: 'VÃ o phÃ²ng â†’', or: 'hoáº·c nháº­p mÃ£ phÃ²ng', room_id_placeholder: 'MÃ£ 6 kÃ½ tá»±...',
        room_created: 'PhÃ²ng Ä‘Ã£ táº¡o', share_hint: 'Gá»­i mÃ£ phÃ²ng cho ngÆ°á»i kia.', copy_id: 'Sao chÃ©p mÃ£', copy_link: 'Sao chÃ©p link', waiting_peer: 'Äang chá» ngÆ°á»i kia...', cancel: 'Huá»·', p2p_note: 'P2P Â· PeerJS Â· KhÃ´ng lÆ°u dá»¯ liá»‡u',
        leave_room: 'ThoÃ¡t', clear_chat: 'XoÃ¡ há»™i thoáº¡i', clear_confirm: 'XoÃ¡ toÃ n bá»™ tin nháº¯n?', send: 'Gá»­i', msg_placeholder: 'Nháº­p tin nháº¯n...', attach_file: 'Gá»­i file (20MB)', timeout_warning: 'âš  KhÃ´ng hoáº¡t Ä‘á»™ng â€” sáº½ ngáº¯t sau',
        dc_title: 'PhÃ²ng Ä‘Ã£ Ä‘Ã³ng', dc_desc: 'Káº¿t ná»‘i bá»‹ ngáº¯t.', new_room: 'Táº¡o phÃ²ng má»›i',
        sys_connected: 'âœ“ Káº¿t ná»‘i P2P thÃ nh cÃ´ng', sys_peer_joined: 'NgÆ°á»i kia Ä‘Ã£ vÃ o phÃ²ng', sys_peer_left: 'NgÆ°á»i kia Ä‘Ã£ rá»i phÃ²ng', sys_peer_blur: 'âš  NgÆ°á»i kia khÃ´ng xem mÃ n hÃ¬nh', sys_peer_focus: 'NgÆ°á»i kia Ä‘Ã£ quay láº¡i', sys_you_blur: 'Tab máº¥t focus â€” ngÆ°á»i kia Ä‘Ã£ Ä‘Æ°á»£c thÃ´ng bÃ¡o',
        sys_file_send: 'Äang gá»­i file...', sys_file_done: 'âœ“ Gá»­i file xong', sys_file_ready: 'File Ä‘Ã£ sáºµn sÃ ng', sys_relay: 'âš  Äang dÃ¹ng TURN relay', sys_cleared: 'Há»™i thoáº¡i Ä‘Ã£ Ä‘Æ°á»£c xoÃ¡',
        err_full: 'PhÃ²ng Ä‘Ã£ Ä‘á»§ 2 ngÆ°á»i', err_not_found: 'KhÃ´ng tÃ¬m tháº¥y phÃ²ng', err_connect: 'KhÃ´ng thá»ƒ káº¿t ná»‘i', err_no_chan: 'ChÆ°a cÃ³ káº¿t ná»‘i', err_file_size: 'File vÆ°á»£t 20MB', copied: 'ÄÃ£ sao chÃ©p!',
        me: 'Báº¡n', them: 'NgÆ°á»i kia', download: 'Táº£i xuá»‘ng',
      }
    }
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§3  UI helpers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);

function showScreen(name) {
  $('setup-screen').classList.toggle('hidden', name !== 'setup');
  $('chat-screen').classList.toggle('hidden',  name !== 'chat');
}

function setStatus(cls, key) {
  $('status-pill').className = cls ? `status-pill ${cls}` : 'status-pill';
  $('status-text').textContent = t(key);
}

/** Alert banner (tá»± xoÃ¡ sau autoMs náº¿u > 0) */
function addAlert(type, key, autoMs = 0) {
  const bar = document.createElement('div');
  bar.className = `alert-banner ${type}`;
  bar.textContent = t(key);
  $('alerts').appendChild(bar);
  if (autoMs > 0) setTimeout(() => bar.remove(), autoMs);
  return bar;
}
function removeAlert(el) { el?.remove(); }

/** Sao chÃ©p + flash button */
async function copyText(text, btn) {
  try {
    await navigator.clipboard.writeText(text);
    if (btn) {
      const orig = btn.textContent;
      btn.textContent = t('copied');
      btn.classList.add('flash');
      setTimeout(() => { btn.textContent = orig; btn.classList.remove('flash'); }, 1300);
    }
  } catch (_) {}
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1_048_576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1_048_576).toFixed(1) + ' MB';
}
function nowTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function getFileIcon(name) {
  const e = (name.split('.').pop() || '').toLowerCase();
  const m = { pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',txt:'ğŸ“ƒ',csv:'ğŸ“Š',xlsx:'ğŸ“Š',pptx:'ğŸ“Š',jpg:'ğŸ–¼',jpeg:'ğŸ–¼',png:'ğŸ–¼',gif:'ğŸ–¼',webp:'ğŸ–¼',svg:'ğŸ–¼',mp4:'ğŸ¬',mkv:'ğŸ¬',avi:'ğŸ¬',mov:'ğŸ¬',mp3:'ğŸµ',wav:'ğŸµ',flac:'ğŸµ',zip:'ğŸ“¦',rar:'ğŸ“¦','7z':'ğŸ“¦',tar:'ğŸ“¦',js:'ğŸ“œ',ts:'ğŸ“œ',py:'ğŸ',html:'ğŸŒ',css:'ğŸ¨',json:'ğŸ“‹' };
  return m[e] || 'ğŸ“';
}

/* â”€â”€ Message renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addMsg(text, isMe) {
  const w = document.createElement('div'); w.className = `bw ${isMe ? 'me' : 'them'}`;
  const b = document.createElement('div'); b.className = 'bubble'; b.textContent = text;
  const m = document.createElement('div'); m.className = 'bmeta';
  m.textContent = `${isMe ? t('me') : t('them')} Â· ${nowTime()}`;
  w.appendChild(b); w.appendChild(m);
  $('messages').appendChild(w); scrollBottom();
}

function addSys(msgOrKey, cls = '', isKey = true) {
  const el = document.createElement('div'); el.className = `sys ${cls}`;
  el.textContent = isKey ? t(msgOrKey) : msgOrKey;
  $('messages').appendChild(el); scrollBottom();
}

function scrollBottom() { const m = $('messages'); m.scrollTop = m.scrollHeight; }

function createFileBubble(fileName, fileSize, isMe, downloadUrl = null) {
  const w  = document.createElement('div'); w.className = `bw ${isMe ? 'me' : 'them'}`;
  const fb = document.createElement('div'); fb.className = 'file-bw';
  const ico = document.createElement('div'); ico.className = 'file-ico'; ico.textContent = getFileIcon(fileName);
  const info = document.createElement('div'); info.className = 'file-info';
  const nm = document.createElement('div');  nm.className = 'file-name'; nm.textContent = fileName;
  const sz = document.createElement('div');  sz.className = 'file-size'; sz.textContent = formatBytes(fileSize);
  const pg = document.createElement('div');  pg.className = 'file-prog';
  const bar= document.createElement('div');  bar.className = 'file-prog-bar';
  pg.appendChild(bar); info.appendChild(nm); info.appendChild(sz); info.appendChild(pg);
  fb.appendChild(ico); fb.appendChild(info);
  if (downloadUrl) {
    const a = document.createElement('a'); a.className = 'btn btn-secondary btn-sm';
    a.href = downloadUrl; a.download = fileName; a.textContent = t('download');
    a.style.marginLeft = '10px'; a.style.flexShrink = '0';
    fb.appendChild(a); bar.style.width = '100%';
  }
  const meta = document.createElement('div'); meta.className = 'bmeta';
  meta.textContent = `${isMe ? t('me') : t('them')} Â· ${nowTime()}`;
  w.appendChild(fb); w.appendChild(meta);
  $('messages').appendChild(w); scrollBottom();
  return { wrap: w, progressBar: bar };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§4  PeerJS / WebRTC
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let myPeer      = null;
let conn        = null;
let roomId      = null;
let isConnected = false;

/** Sinh Room ID 6 kÃ½ tá»± dá»… Ä‘á»c */
function genRoomId() {
  const chars = CONFIG.ROOM_CHARS;
  const bytes = new Uint8Array(CONFIG.ROOM_LEN);
  crypto.getRandomValues(bytes);
  return Array.from(bytes).map(b => chars[b % chars.length]).join('');
}

/** Caller: táº¡o phÃ²ng */
function createRoom() {
  roomId = genRoomId();
  myPeer = new Peer(roomId, { debug: 0 });
  setStatus('connecting', 'status_connecting');

  myPeer.on('open', () => {
    $('room-id-display').textContent = roomId;
    $('action-card').classList.add('hidden');
    $('waiting-card').classList.remove('hidden');
    setStatus('connecting', 'status_waiting');
  });

  // Nháº­n káº¿t ná»‘i tá»« Callee
  myPeer.on('connection', incoming => {
    if (conn) { incoming.close(); return; } // phÃ²ng Ä‘Ã£ Ä‘á»§ ngÆ°á»i
    setupConn(incoming);
    addSys('sys_peer_joined', 'ok');
  });

  myPeer.on('error', err => {
    if (err.type === 'unavailable-id') { myPeer.destroy(); createRoom(); return; }
    addAlert('danger', 'err_connect', 5000);
    setStatus('error', 'status_error');
  });
}

/** Callee: vÃ o phÃ²ng */
function joinRoom(rid) {
  roomId = rid;
  myPeer = new Peer({ debug: 0 });
  setStatus('connecting', 'status_connecting');

  myPeer.on('open', () => {
    setupConn(myPeer.connect(roomId, { reliable: true, serialization: 'raw' }));
  });

  myPeer.on('error', err => {
    addAlert('danger', err.type === 'peer-unavailable' ? 'err_not_found' : 'err_connect', 5000);
    setStatus('error', 'status_error');
    hardReset();
  });
}

/** Thiáº¿t láº­p DataConnection */
function setupConn(c) {
  conn = c;
  conn.serialization = 'raw';

  conn.on('open', () => {
    isConnected = true;
    showScreen('chat');
    $('chat-room-val').textContent = roomId;
    heartbeat.start();
    inactivity.reset();
    setStatus('connected', 'status_connected');
    addSys('sys_connected', 'ok');
    setTimeout(() => checkRelayUsage(), 3000);
  });

  conn.on('data', data => {
    if (typeof data === 'string') handleTextMsg(data);
    else fileTransfer.handleChunk(data);
  });

  conn.on('close', () => handleDisconnect('peer'));
  conn.on('error', () => handleDisconnect('error'));
}

/** Xá»­ lÃ½ JSON message */
function handleTextMsg(raw) {
  try {
    const msg = JSON.parse(raw);
    switch (msg.type) {
      case 'chat':
        // Chá»‰ reset inactivity khi nháº­n tin nháº¯n chat thá»±c sá»±
        inactivity.reset();
        addMsg(msg.text, false);
        break;
      case 'ping':
        dcSend({ type: 'pong' });
        break;
      case 'pong':
        heartbeat.gotPong();
        break;
      case 'file-meta':
        inactivity.reset();
        fileTransfer.startReceiving(msg);
        break;
      case 'tab_blur':
        // Peer kia Ä‘ang máº¥t focus â€” hiá»‡n cáº£nh bÃ¡o cho mÃ¬nh
        addSys('sys_peer_blur', 'warn');
        break;
      case 'tab_focus':
        // Peer kia Ä‘Ã£ quay láº¡i
        addSys('sys_peer_focus', 'ok');
        break;
      case 'bye':
        handleDisconnect('peer');
        break;
      default: break;
    }
  } catch (_) {}
}

/** Gá»­i chat */
function sendChat(text) {
  if (!conn?.open) { addSys(t('err_no_chan'), 'danger', false); return; }
  dcSend({ type: 'chat', text });
  addMsg(text, true);
  inactivity.reset();
}

function dcSend(obj) {
  try { if (conn?.open) conn.send(JSON.stringify(obj)); } catch (_) {}
}
function dcSendBinary(buf) {
  try { if (conn?.open) conn.send(buf); } catch (_) {}
}

/** Kiá»ƒm tra TURN relay */
async function checkRelayUsage() {
  try {
    const pc    = conn?.peerConnection;
    if (!pc) return;
    const stats = await pc.getStats();
    stats.forEach(r => {
      if (r.type === 'candidate-pair' && r.state === 'succeeded') {
        if (stats.get(r.localCandidateId)?.candidateType === 'relay') {
          addAlert('warn', 'sys_relay', 8000);
          addSys('sys_relay', 'warn');
        }
      }
    });
  } catch (_) {}
}

function handleDisconnect(reason) {
  if (!isConnected && reason !== 'peer' && reason !== 'user') return;
  isConnected = false;
  heartbeat.stop();
  inactivity.stop();
  tabFocus.stop();
  if (reason === 'peer') addSys('sys_peer_left', 'danger');
  dcSend({ type: 'bye' });
  try { conn?.close();     conn    = null; } catch (_) {}
  try { myPeer?.destroy(); myPeer  = null; } catch (_) {}
  setStatus('error', 'status_error');
  setTimeout(() => $('dc-overlay').classList.add('visible'), 500);
}

function hardReset() {
  try { conn?.close();     conn    = null; } catch (_) {}
  try { myPeer?.destroy(); myPeer  = null; } catch (_) {}
  isConnected = false; roomId = null;
  heartbeat.stop(); inactivity.stop(); tabFocus.stop();
  fileTransfer.reset();
  $('messages').innerHTML = '';
  $('alerts').innerHTML   = '';
  $('join-input').value   = '';
  $('waiting-card').classList.add('hidden');
  $('action-card').classList.remove('hidden');
  $('dc-overlay').classList.remove('visible');
  $('timeout-bar').classList.remove('visible');
  setStatus('', 'status_idle');
  showScreen('setup');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§5  File transfer
   â”€â”€ Header packet: [4-byte idLen][idBytes][chunkData] â”€â”€
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fileTransfer = {
  _rx: {},

  async send(file) {
    if (!conn?.open) { addSys(t('err_no_chan'), 'danger', false); return; }
    if (file.size > CONFIG.MAX_FILE_SIZE) { addSys(t('err_file_size'), 'danger', false); return; }

    const tid         = crypto.randomUUID();
    const totalChunks = Math.ceil(file.size / CONFIG.CHUNK_SIZE);
    const { progressBar } = createFileBubble(file.name, file.size, true);

    dcSend({ type:'file-meta', tid, name:file.name, size:file.size, totalChunks, mime:file.type||'application/octet-stream' });
    addSys('sys_file_send');

    const buf = await file.arrayBuffer();
    const idB = new TextEncoder().encode(tid);

    for (let i = 0; i < totalChunks; i++) {
      const start  = i * CONFIG.CHUNK_SIZE;
      const slice  = buf.slice(start, Math.min(start + CONFIG.CHUNK_SIZE, file.size));
      const packet = new Uint8Array(4 + idB.length + slice.byteLength);
      new DataView(packet.buffer).setUint32(0, idB.length, true);
      packet.set(idB, 4);
      packet.set(new Uint8Array(slice), 4 + idB.length);
      dcSendBinary(packet.buffer);
      progressBar.style.width = `${Math.round((i + 1) / totalChunks * 100)}%`;
      // Yield CPU má»—i 10 chunk
      if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
      inactivity.reset();
    }
    addSys('sys_file_done', 'ok');
  },

  startReceiving(meta) {
    const { progressBar } = createFileBubble(meta.name, meta.size, false);
    this._rx[meta.tid] = { meta, chunks:[], received:0, progressBar };
  },

  handleChunk(data) {
    const view  = new DataView(data);
    const idLen = view.getUint32(0, true);
    const tid   = new TextDecoder().decode(new Uint8Array(data, 4, idLen));
    const chunk = data.slice(4 + idLen);
    const entry = this._rx[tid];
    if (!entry) return;
    entry.chunks.push(chunk);
    entry.received += chunk.byteLength;
    entry.progressBar.style.width = `${Math.round(entry.received / entry.meta.size * 100)}%`;
    if (entry.chunks.length >= entry.meta.totalChunks) {
      const blob = new Blob(entry.chunks.map(c => new Uint8Array(c)), { type: entry.meta.mime });
      const url  = URL.createObjectURL(blob);
      createFileBubble(entry.meta.name, entry.meta.size, false, url);
      addSys(`${t('sys_file_ready')}: ${entry.meta.name}`, 'ok', false);
      setTimeout(() => URL.revokeObjectURL(url), 3_600_000);
      delete this._rx[tid];
    }
  },

  reset() { this._rx = {}; },
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§6  Heartbeat â€” ping/pong má»—i 10 giÃ¢y
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const heartbeat = {
  _ping: null, _pong: null,
  start() {
    this.stop();
    this._ping = setInterval(() => {
      if (conn?.open) {
        dcSend({ type: 'ping' });
        this._pong = setTimeout(() => handleDisconnect('heartbeat'), CONFIG.PONG_TIMEOUT_MS);
      }
    }, CONFIG.HEARTBEAT_MS);
  },
  gotPong() { if (this._pong) { clearTimeout(this._pong); this._pong = null; } },
  stop() {
    if (this._ping) { clearInterval(this._ping); this._ping = null; }
    if (this._pong) { clearTimeout(this._pong);  this._pong = null; }
  },
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§7  Inactivity timeout
   â”€â”€ Chá»‰ tÃ­nh khi khÃ´ng cÃ³ chat/file, KHÃ”NG tÃ­nh blur/focus â”€â”€
   â”€â”€ Sau INACTIVITY_MS â†’ Ä‘áº¿m ngÆ°á»£c INACTIVITY_CD_S giÃ¢y rá»“i ngáº¯t â”€â”€
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const inactivity = {
  _idle: null, _cd: null, _secs: 0,

  reset() {
    if (!isConnected) return;
    this._clearAll();
    $('timeout-bar').classList.remove('visible');
    this._idle = setTimeout(
      () => this._startCountdown(CONFIG.INACTIVITY_CD_S),
      CONFIG.INACTIVITY_MS - CONFIG.INACTIVITY_CD_S * 1000
    );
  },

  _startCountdown(secs) {
    this._secs = secs;
    this._tick();
    $('timeout-bar').classList.add('visible');
    this._cd = setInterval(() => {
      this._secs--;
      this._tick();
      if (this._secs <= 0) { this.stop(); handleDisconnect('timeout'); }
    }, 1000);
  },

  _tick() { const el = $('countdown'); if (el) el.textContent = this._secs; },

  _clearAll() {
    if (this._idle) { clearTimeout(this._idle);   this._idle = null; }
    if (this._cd)   { clearInterval(this._cd);    this._cd   = null; }
  },

  stop() { this._clearAll(); $('timeout-bar').classList.remove('visible'); },
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§8  Tab-focus notification
   â”€â”€ Khi tab máº¥t focus: gá»­i tab_blur cho peer kia (khÃ´ng tá»± ngáº¯t) â”€â”€
   â”€â”€ Khi tab focus láº¡i: gá»­i tab_focus cho peer kia               â”€â”€
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const tabFocus = {
  _blurred: false,

  onBlur() {
    if (!isConnected || this._blurred) return;
    this._blurred = true;
    // Cáº£nh bÃ¡o báº£n thÃ¢n
    addSys('sys_you_blur', 'warn');
    // ThÃ´ng bÃ¡o peer kia
    dcSend({ type: 'tab_blur' });
  },

  onFocus() {
    if (!isConnected || !this._blurred) return;
    this._blurred = false;
    // ThÃ´ng bÃ¡o peer kia
    dcSend({ type: 'tab_focus' });
  },

  stop() { this._blurred = false; },
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§9  Event listeners
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// Äá»•i ngÃ´n ngá»¯
$('lang-select').addEventListener('change', e => {
  lang = e.target.value;
  applyI18n();
});

// Táº¡o phÃ²ng
$('btn-create').addEventListener('click', () => {
  $('btn-create').disabled = true;
  createRoom();
  setTimeout(() => { $('btn-create').disabled = false; }, 3000);
});

// VÃ o phÃ²ng
$('btn-join').addEventListener('click', () => {
  const rid = $('join-input').value.trim().toUpperCase();
  if (rid.length !== CONFIG.ROOM_LEN) { $('join-input').focus(); return; }
  $('btn-join').disabled = true;
  joinRoom(rid);
  setTimeout(() => { $('btn-join').disabled = false; }, 5000);
});

// Enter trong Ã´ nháº­p mÃ£
$('join-input').addEventListener('keydown', e => { if (e.key === 'Enter') $('btn-join').click(); });

// Tá»± Ä‘á»™ng viáº¿t hoa, lá»c kÃ½ tá»± há»£p lá»‡
$('join-input').addEventListener('input', function () {
  const pos = this.selectionStart;
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, CONFIG.ROOM_LEN);
  this.setSelectionRange(pos, pos);
});

// Sao chÃ©p mÃ£ phÃ²ng
$('btn-copy-id').addEventListener('click', e => copyText(roomId, e.currentTarget));

// Sao chÃ©p link
$('btn-copy-link').addEventListener('click', e => {
  const url = `${location.origin}${location.pathname}?room=${roomId}`;
  copyText(url, e.currentTarget);
});

// Huá»· chá»
$('btn-cancel').addEventListener('click', () => {
  try { myPeer?.destroy(); myPeer = null; } catch (_) {}
  $('waiting-card').classList.add('hidden');
  $('action-card').classList.remove('hidden');
  setStatus('', 'status_idle');
});

// Gá»­i tin nháº¯n
$('btn-send').addEventListener('click', () => {
  const inp = $('msg-input');
  const txt = inp.value.trim();
  if (!txt) return;
  sendChat(txt);
  inp.value = '';
  inp.style.height = 'auto';
});

$('msg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $('btn-send').click(); }
});

// Auto-resize textarea
$('msg-input').addEventListener('input', function () {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// XoÃ¡ há»™i thoáº¡i
$('btn-clear').addEventListener('click', () => {
  if (!confirm(t('clear_confirm'))) return;
  $('messages').innerHTML = '';
  addSys('sys_cleared', 'ok');
});

// ThoÃ¡t phÃ²ng
$('btn-disconnect').addEventListener('click', () => handleDisconnect('user'));

// Khá»Ÿi Ä‘á»™ng láº¡i
$('btn-restart').addEventListener('click', () => hardReset());

// Gá»­i file â€” nÃºt trong input row
$('btn-attach').addEventListener('click', () => $('file-input').click());
$('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  fileTransfer.send(file);
  e.target.value = '';
});

// Drag & drop
$('chat-screen').addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
$('chat-screen').addEventListener('drop', e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (file) fileTransfer.send(file);
});

// Tab blur / focus â€” chá»‰ THÃ”NG BÃO peer, khÃ´ng tá»± ngáº¯t
document.addEventListener('visibilitychange', () => {
  if (!isConnected) return;
  document.hidden ? tabFocus.onBlur() : tabFocus.onFocus();
});
window.addEventListener('blur',  () => { if (isConnected) tabFocus.onBlur();  });
window.addEventListener('focus', () => { if (isConnected) tabFocus.onFocus(); });

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§10  Boot
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function init() {
  // Táº£i ngÃ´n ngá»¯ trÆ°á»›c khi hiá»‡n UI
  await loadI18n();
  buildLangDropdown();
  applyI18n();

  // áº¨n loading overlay
  $('loading-overlay').classList.add('done');

  showScreen('setup');
  setStatus('', 'status_idle');

  // Tá»± Ä‘iá»n mÃ£ phÃ²ng náº¿u URL cÃ³ ?room=XXXXXX
  const urlRoom = new URLSearchParams(location.search).get('room');
  if (urlRoom) {
    const cleaned = urlRoom.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, CONFIG.ROOM_LEN);
    $('join-input').value = cleaned;
    if (cleaned.length === CONFIG.ROOM_LEN) {
      setTimeout(() => $('btn-join').click(), 400);
    }
  }
}

init();
/* â”€â”€ EOF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
</script>
</body>
</html>
